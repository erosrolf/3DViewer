pipeline {
  agent any

  environment {
    TELEGRAM_TOKEN = credentials('telegram-bot-token')
    CHAT_ID = "-1002115020059"
  }

  stages {
    stage("core_lib_build") {
      steps {
        sh 'printenv'
        echo "Start build core lib"
        dir ('src'){
          sh 'make build/core_lib.a'
        }
      }
    }

    stage("core_test") {
      steps {
        echo "Start build core test"
        dir('src') {
          sh 'make core_test'
        }
      }
    }
  }

  post {
    always {
      script {
        env.GIT_COMMIT_AUTHOR = sh(script: "git log -1 --pretty=format:'%an'", returnStdout: true).trim()
        env.GIT_COMMIT_MESSAGE = sh(script: "git log -1 --pretty=format:'%s'", returnStdout: true).trim()
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º GIT_BRANCH, –µ—Å–ª–∏ –æ–Ω –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ
        env.GIT_BRANCH = sh(script: "git rev-parse --abbrev-ref HEAD", returnStdout: true).trim()
      }
    }
    success {
      script {
        env.PIPELINE_STATUS = "‚úÖ"
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        def message = "üíºüíºüíº\nBuild number ${env.BUILD_NUMBER} pushed to ${env.GIT_BRANCH}, CI status = ${env.PIPELINE_STATUS}!\nLast commit by ${env.GIT_COMMIT_AUTHOR}: ${env.GIT_COMMIT_MESSAGE}"
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
        sh "curl -s -X POST https://api.telegram.org/bot${env.TELEGRAM_TOKEN}/sendMessage -d chat_id=${env.CHAT_ID} -d text="$message""
      }
    }
    failure {
      script {
        env.PIPELINE_STATUS = "‚ùå"
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        def message = "üíºüíºüíº\nBuild number ${env.BUILD_NUMBER} pushed to ${env.GIT_BRANCH}, CI status = ${env.PIPELINE_STATUS}!\nLast commit by ${env.GIT_COMMIT_AUTHOR}: ${env.GIT_COMMIT_MESSAGE}"
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
        sh "curl -s -X POST https://api.telegram.org/bot${env.TELEGRAM_TOKEN}/sendMessage -d chat_id=${env.CHAT_ID} -d text="$message""
      }
    }
  }
}
